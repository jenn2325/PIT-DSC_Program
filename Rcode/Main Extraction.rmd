---
title: "PIT-DSC Parsing Science Policy Issues"
date: "7/30/2021"
---

The parsing of each target data value follows the same steps.

1. Initializing path where all community health profiles are located, load libraries,initialize areas, and creating an empty matrix.
2. Iterate through the path and extract target value.
3. Clean data, and return a final data frame.


### Libraries 
```{r message=FALSE}
library(tabulizer)
library(plyr)
library(tidyverse)
library(pdftools)
library(tm)
```



## Who We Are(demographic Data)

A newer data was found on Community District Profiles


```{r}
whoWeAre <- read.csv("chp-fulldata.csv")

colnames(whoWeAre) <- c("ID","Boroughs","Name","Overall_pop","Race_White", "Race_Black","Race_Asian","Race_Latino","Race_Other", "Age0to17","Age18to24","Age25to44","Age45to64","Age65plus","Ltd_Eng_Prof", "X1","x2", "x3", "Born_Outside_US")
whoWeAre <- whoWeAre %>%
  select(Boroughs, Name, Overall_pop ,Race_White, Race_Black , Race_Asian,Race_Latino , Race_Other, Age0to17, Age18to24, Age25to44,Age45to64, Age65plus, Ltd_Eng_Prof, Born_Outside_US )
whoWeAre <- whoWeAre[c(-1:-6,-66:-69),]
whoWeAre <- whoWeAre %>% 
  group_by(Boroughs) %>% 
  mutate(District = row_number()) %>% 
  mutate(District = ifelse(Boroughs == 'Manhattan', paste('mn', District, sep = ""), ifelse(Boroughs == 'Bronx', paste('bx', District, sep = ""), ifelse(Boroughs == 'Brooklyn', paste('bk', District, sep = ""), ifelse(Boroughs == 'Queens', paste('qn', District, sep = ""), paste('si', District, sep = "")))))) %>% 
  .[,c(16,1:15)]


i <- 4:16
whoWeAre[,i] <- apply(whoWeAre[,i], 2, as.numeric)
a <- c(5:16)
whoWeAre[ ,a] <- apply(whoWeAre[,a],2, as.numeric)/100
rm(a,i)
```


## Social and Economic Conditions

### Education(page 6)

#### Elementary School Absenteeism 
```{r}
#Assigning a dataframe which will create the dataframe
percent_esa <- data.frame()

#Locate the health profiles
all_files <- list.files(path = "Health_Profiles/")


#This entire for loop will read all of the files based on the location on where the extract text is based on the coordinates and will produce the data in that same spot of each pdf page
for(i in seq_along(all_files)){

     current_file <- all_files[i]

     out <- extract_text(paste("Health_Profiles/",current_file,sep = ""), pages = 6, area = list(c(195, 35, 418, 87)))

     percents <- out %>% regmatches(., gregexpr("[0-9]{1,2}\\%", .))
    
     current_info <- tibble(location = current_file, current_stats = percents)
     
     percent_esa <- percent_esa %>% bind_rows(current_info)

}

percent_esa$location <- substr(percent_esa$location,1,nchar(percent_esa$location)-4)#This is to remove .pdf from each district name  
colnames(percent_esa) <- c("District", "Elementary_School_Absenteeism")#
percent_esa $ Elementary_School_Absenteeism <- unlist(percent_esa$Elementary_School_Absenteeism)#This is to flatten the second column

percent_esa #Initiating the dataframe to produce the data
rm(current_info, percents, current_file, i, out)

```

#### On-Time High School Graduation

```{r}
percent_othsg <- data.frame()

#This entire for loop will read all of the files based on the location on where the extract text is based on the coordinates and will produce the data in that same spot of each pdf page
for(i in seq_along(all_files)){
     

     current_file <- all_files[i]

     out <- extract_text(paste("Health_Profiles/",current_file,sep = ""), pages = 6, area = list(c(226, 299, 417, 361)))

     percents <- out %>% regmatches(., gregexpr("[0-9]{1,2}\\%", .))
     

     current_info <- tibble(location = current_file,
                            current_stats = percents)

     percent_othsg <- percent_othsg %>% bind_rows(current_info)

}

percent_othsg$location <- substr(percent_othsg$location,1,nchar(percent_othsg$location)-4)#This is to remove the .pdf from each district
colnames(percent_othsg) <- c("District", "On_time_high_school_graduation")#This is to change the name of the column names
percent_othsg$On_time_high_school_graduation <- unlist(percent_othsg$On_time_high_school_graduation)#This is to flatten the second column

percent_othsg #Initiating the dataframe to produce the data
rm(current_info, percents, current_file, i, out)
```

#### Highest Level of Education Achieved

```{r}
percent_hloea <- data.frame()

#This entire for loop will read all of the files based on the location on where the extract text is based on the coordinates and will produce the data in that same spot of each pdf page
for(i in seq_along(all_files)){
     

     current_file <- all_files[i]



     out <- extract_text(paste("Health_Profiles/",current_file,sep = ""), pages = 6, area = list(c(542, 128, 589, 419)))

     percents <- out %>% regmatches(., gregexpr("[0-9]{1,2}\\%", .))
   

     current_info <- tibble(location = current_file,
                            current_stats = percents)

     percent_hloea <- percent_hloea %>% bind_rows(current_info)

}

percent_hloea$location <- substr(percent_hloea$location,1,nchar(percent_hloea$location)-4)#This is to remove the .pdf from each district
colnames(percent_hloea) <- c("District", "Less_than_High_School_High_School_graduate_or_some_college_or_College_graduate")#This is to change the name of the column for the dataframe
percent_hloea <- percent_hloea%>% unnest_wider(Less_than_High_School_High_School_graduate_or_some_college_or_College_graduate) #assigning this to be able to separate and rename the columns in tb1_df

colnames(percent_hloea)[2:4] <- c("Less than high school", "High School Graduate or some college", "College graduate") #The renaming of each column
           
percent_hloea #initiating the tb1_df with different column names
rm(current_info, percents, current_file, i, out)
```
Combine Education Statistics
```{r}
Education <- left_join(percent_esa, percent_othsg, by="District") %>% left_join(., percent_hloea, by="District") 
rm(percent_esa, percent_othsg, percent_hloea)
```


### Economic Stress (Page 7)
```{r}
EconomicStress <- data.frame()
for(i in 1:59){
  #Change Page 7 from PDF to text
  doc <- pdf_text(paste("Health_Profiles/", all_files[i], sep=""))[[7]] %>% 
    #Standardizes formated and removes blank spaces
    str_replace_all("(\\n)", " ") %>% str_squish()
  #Extracts percentages and districts namer from the the page
df <- data.frame(District = str_extract(all_files[i], "(bx|qn|mn|si|bk)[0-9]{1,4}"),
                 DistrictName=str_to_title(regmatches(doc, regexec("HEALTH PROFILES 2018:\\s*(.*?)\\s*7", doc))[[1]][2]),
                 Poverty=str_extract(str_extract(doc, "Poverty [0-9]{1,2}% [0-9]{1,2}% [0-9]{1,2}%"), "[0-9]{1,2}"),
                 Unemployment=str_extract(str_extract(doc, "Unemployment [0-9]{1,2}% [0-9]{1,2}% [0-9]{1,2}%"), "[0-9]{1,2}"),
                 RentBurden=str_extract(str_extract(doc, "Rent Burden [0-9]{1,2}% [0-9]{1,2}% [0-9]{1,2}%"), "[0-9]{1,2}"),
                 AvertableDeaths=str_extract(str_extract(doc, "[0-9]{1,2}% of deaths could have been averted"), "[0-9]{1,2}"))
EconomicStress <- rbind(EconomicStress, df)
}
rm(df, doc, i)
```

#### Non-Fatal Assult Hospitalizations 

```{r}
df_nf_hospitalizations = data.frame()

alt_area = list(c(181.6539, 36.5285, 204.9078, 307.3679 ))

for (i in 1:59){
  t_fname = paste("Health_Profiles/", all_files[i], sep="")
  
  out <- extract_text(t_fname, pages = 8, area = list(c(170, 37, 191,338)))
  
  if (grepl("100,000", out, fixed=TRUE)){
    out <- extract_text(t_fname, pages = 8, area = alt_area)}
  
  out <- gsub("\r?\n|\r", "", out)
  
  m <- gsub("[^0-9]", "", out)

  m <- sub('.', '', m)
  
  
  d = data.frame(District = str_extract(all_files[i], "(bx|qn|mn|si|bk)[0-9]{1,4}") ,df_nf_hospitalizations =m)
  df_nf_hospitalizations = rbind(df_nf_hospitalizations, d)
}

df_nf_hospitalizations
rm(alt_area, d, i, m, out, t_fname)
```

#### Jail Incarceration
```{r}
ji <-  c()
# Extract Jail Incarceration data from all districts
for (i in 1:59) {
    out <- extract_text(paste("Health_Profiles/", all_files[i], sep = ""), pages = 8, area = list(c(422,60.7,532,462))) %>%
           str_remove_all(",")
    res <- ifelse(all_files[i] == "mn8.pdf", unlist(str_match_all(out, "[0-9]{2,4}")) %>% as.numeric(), 
                    unlist(str_match_all(out, "[0-9]{2,4}")) %>% data.frame() %>% filter(. != "71") %>% unlist() %>% as.numeric())
    j = data.frame(District = str_extract(all_files[i], "(bx|qn|mn|si|bk)[0-9]{1,4}") ,Jail_Incarceration = res)
  ji = rbind(ji, j)
}
ji
rm(j, i, out, res)
```

Combine Violence Statistics
```{r}
Violence <- left_join(df_nf_hospitalizations, ji, by = "District")
rm(df_nf_hospitalizations, ji)
```


### Housing and Neighbourhood Conditions

#### Helpful Neighbors
```{r}
hn = {}

normal_area = list(c(610.8245, 306.6939, 631.6408, 495.4286))
for (i in 1:59){
  t_fname = paste("Health_Profiles/", all_files[i], sep="")
  
  out <- extract_text(t_fname, pages = 8, area = normal_area)
  m <- out %>% regmatches(., gregexpr("[0-9]{1,2}\\%", .))
  m <- tail(m[[1]],1)
 
  d = data.frame(Districts = str_extract(all_files[i], "(bx|qn|mn|si|bk)[0-9]{1,4}") ,Helpful_neighbours = m)
  hn = rbind(hn, d)
}

hn
rm(d, normal_area, i, m, out, t_fname)
```




#### Air Conditioning

```{r}
# locate the health profiles pdfs(make sure to change to your own directory)
pdf_path = list.files(path = "Health_Profiles/")

#lists the files in the path where our pdf's are stored
AC = matrix(NA, ncol = 1, nrow = 59) 
areas =  c(276, 36, 330, 79)

#iterate through pdf's and extract target data value, being conscious of misc values
for(i in 1:59){
  pdfText = extract_text(paste("Health_Profiles/",pdf_path[i], sep ="" ),pages = 9, area = list(areas))
  values = unlist(str_match_all(pdfText,"[0-9]{1,2}%"))
  if(length(values) == 2){
    AC[i,] = values[2]
  }
  else{
    AC[i,] = values[1]
  }
}

#clean data, turn decimals into percents, turn whole thing into a data frame.
new_ac = gsub("%", "", AC)
AC = apply(new_ac, 2, as.numeric)/100
rm(new_ac)

Districts = substr(pdf_path,start = 0, stop = nchar(pdf_path)- 4)
acRates = data.frame(cbind(Districts, AC))
colnames(acRates) = c("Districts","Air_Conditioning_Rates")
rm(AC, areas,  i, pdfText, values)
#lists the files in the path where our pdf's are stored
```

#### Air Pollution
```{r}
Air_Pollution <- read.csv("AirPollution.csv") %>% 
  .[,-1] %>% 
  mutate(Community.District = str_remove_all(Community.District,"\\(CD[0-9]{1,2}\\)")) %>% 
  mutate(Community.District = str_trim(Community.District))
Air_Pollution <- whoWeAre %>% ungroup() %>% select(District, Name) %>% left_join(., Air_Pollution, by = c("Name" = "Community.District"))
colnames(Air_Pollution) <- c("Districts","District_long_name", "Air Pollution")
```


#### Home without Maintenance Defects

```{r}
defect_Rates = matrix(NA, ncol = 1, nrow = 59) 
areas =  c(554, 46, 658, 90)

#iterate through pdf's and extract target data value
for(i in 1:59){
  pdfText = extract_text(paste("Health_Profiles/",pdf_path[i], sep = ""),pages = 9, area = list(areas))
  values = unlist(str_match_all(pdfText,"[0-9]{1,2}%"))
  defect_Rates[i,] = values
}

#clean data, turn decimals into percents, turn whole thing into a data frame.
new_df = gsub("%", "", defect_Rates)
defect_Rates = apply(new_df, 2, as.numeric)/100
rm(new_df)

Homes_wo_defects = data.frame(cbind(Districts, defect_Rates))
colnames(Homes_wo_defects) = c("Districts","Rate_of_renter-occupied_homes")
rm(defect_Rates, areas, i, pdfText, values)
```

#### Homes Reporting Cockroaches

```{r}

roach = matrix(NA, ncol = 1, nrow = 59) 
areas =  c(569, 308, 589, 426)

#iterate through pdf's and extract target data value
for(i in 1:59){
  pdfText = extract_text(paste("Health_Profiles/",pdf_path[i],sep = ""),pages = 9, area = list(areas))
  values = unlist(str_match_all(pdfText,"[0-9]{1,2}%"))
  roach[i,] = values
}

#clean data, turn decimals into percents, turn whole thing into a data frame.
new_roach = gsub("%", "", roach)
roach = apply(new_roach, 2, as.numeric)/100
rm(new_roach)

Districts = substr(pdf_path,start = 0, stop = nchar(pdf_path)- 4)
roachRates = data.frame(cbind(Districts, roach))
colnames(roachRates) = c("Districts","Homes_Reporting_Cockroaches")
rm(roach,areas, i, pdfText, values)

```

#### Bicycle Network Coverage, Pedestrain Injuries and Food Environment
```{r}
Housing <- data.frame()

PercentExtract <- function(file, page, area){
  Ex <- extract_text(file, pages= page, area= list(area)) %>%
    str_replace_all("\n", " ") %>% 
    str_extract("[0-9]{1,2}%") %>%
    removePunctuation()
  return(Ex)
}
# Enviroment variables for Cleaning
WordToNum <- c(no=0, one=1, two=2, three=3, four=4, five=5, six=6, seven=7, eight=8, nine=9, ten=10)

for(i in 1:59) {
  #Identifies the files in their files
  File <- paste("Health_Profiles/", all_files[i], sep="")
  #Creates the data frame
  df <- data.frame(Districts = str_extract(all_files[i], "(bx|qn|mn|si|bk)[0-9]{1,4}"),
                   #Percentages of Bike Lanes
                   Bike = PercentExtract(File, 10, c(210, 40, 240, 170)),
                   #Pedestrian Injuries per 100k injuries
                   PedInj = str_extract(extract_text(File, pages=10, area=list(c(210, 310, 240, 420))),"[0-9]{1,2}"),
                   #Number of farmers markers in district
                   FarmersMarket = extract_text(File, pages=10, area=list(c(450, 36, 660, 300))) %>% str_replace_all("(\\n)", " ") %>%
                     str_squish() %>% str_extract("(?<=home to\\s)\\w+") %>% revalue(WordToNum,warn_missing = FALSE),
                   #Number of bodegas for every one supermarket
                   Bodegas= extract_text(File, pages=10, area=list(c(400, 310, 540, 580))) %>% str_replace_all("(\\n)", " ") %>%
                     str_squish() %>% str_extract("(?<=there are\\s)\\w+") %>% revalue(WordToNum, warn_missing = FALSE))
  Housing <- rbind(Housing, df)
}

rm(df, File, i, WordToNum)
```

Combine Housing and Neighbourhood Conditions
```{r}
HousingNeighbourhoodConditions <- left_join(hn, acRates, by = "Districts") %>% left_join(.,Air_Pollution, by = "Districts") %>% left_join(.,Homes_wo_defects, by = "Districts") %>% left_join(., roachRates, by = "Districts") %>% left_join(., Housing, by = "Districts") %>% 
  .[,c(1,4,2:3,5:11)]
rm(hn, acRates, Air_Pollution, Homes_wo_defects, roachRates, Housing)
```


## Maternal and Child Health

#### Late or No Parental Care
```{r}
percent_lnpc <- data.frame()

#This entire for loop will read all of the files based on the location on where the extract text is based on the coordinates and will produce the data in that same spot of each pdf page
for(i in seq_along(all_files)){
    
     current_file <- all_files[i]

     out <- extract_text(paste("Health_Profiles/",current_file,sep = ""), pages = 11, area = list(c(213, 30, 331, 571)))

     percents <- out %>% regmatches(., gregexpr("[0-9]{1,2}.[0-9]{1}\\%", .))

     current_info <- tibble(location = current_file, current_stats = percents)

     percent_lnpc <- percent_lnpc %>% bind_rows(current_info)
}
#I will be doing this to modify the data 
#Note: Some numbers in loops may be repeated because more numbers showed up repeated and required
#a second loop to be removed in certain places which will be explained below 
thevalue <- percent_lnpc$current_stats

#This loop is for keeping a percentage at one district and removing it from all the other districts which is the financial district
for (district in 1:59) {
     current_dis <- (thevalue[[district]]) # to String function binds entire column in one string
     if (("1.3%" %in% current_dis) & (district != 31)) {
          percent_lnpc$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "1.3%")
     }
}
#This is to remove the percentage from all the pdf files as it is not important which is the state NYC
thevalue <- percent_lnpc$current_stats
for (district in 1:59) {
     current_dis <- thevalue[[district]]
     percent_lnpc$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "6.7%")
}

#This is to remove the borough percentages from the current stats of districts Bronx
thevalue <- percent_lnpc$current_stats
for (district in 19:30) {
     current_dis <- thevalue[[district]]
     percent_lnpc$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "10.9%")
}
#Some of the borough percentages were not erased so i did another loop to be able to remove them from where they were not removed 
thevalue <- percent_lnpc$current_stats
for (district in 19:30) {
     current_dis <- thevalue[[district]]
     percent_lnpc$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "10.9%")
}
#This is to remove the borough district Brooklyn percentage from the current stats
thevalue <- percent_lnpc$current_stats
for (district in 1:18) {
     current_dis <- thevalue[[district]]
     percent_lnpc$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "6.2%")
}
#This is to remove the borough district Manhattan percentage from the current stats
thevalue <- percent_lnpc$current_stats
for (district in 31:42) {
     current_dis <- thevalue[[district]]
     percent_lnpc$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "4.9%")
}
#This is to remove the borough district Queens percentage from the current stats
thevalue <- percent_lnpc$current_stats
for (district in 43:56) {
     current_dis <- thevalue[[district]]
     percent_lnpc$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "7.9%")
}
#Some were not removed because they were repeated so i did another loop in the districts that needed to be removed  
thevalue <- percent_lnpc$current_stats
for (district in 43:56) {
     current_dis <- thevalue[[district]]
     percent_lnpc$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "7.9%")
}
#This is to remove the borough district staten island percentage from the current stats
thevalue <- percent_lnpc$current_stats
for (district in 57:59) {
     current_dis <- thevalue[[district]]
     percent_lnpc$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "2.5%")
}
#This was a percentage found in the current stats that was highly unnecessary and was removed 
thevalue <- percent_lnpc$current_stats
for (district in 57:59) {
     current_dis <- thevalue[[district]]
     percent_lnpc$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "7.9%")
}
#Below is to remove commas and to modify and organize the data
thevalue <- percent_lnpc$current_stats
for (district in 1:59) {
 
    percent_lnpc$current_stats[[district]] <- percent_lnpc$current_stats[[district]] %>%
          str_remove_all(.,",") %>%
          str_remove(.,"%") %>%
          str_trim() %>%
          as.numeric(.)
         
            
}
percent_lnpc$location <- substr(percent_lnpc$location,1,nchar(percent_lnpc$location)-4) # to remove .pdf from each district 
colnames(percent_lnpc) <- c("District", "late_or_no_prenatal_care") #changing the names of the column 
percent_lnpc$late_or_no_prenatal_care <- unlist(percent_lnpc$late_or_no_prenatal_care) # this is to flatten the second column


percent_lnpc #Initiating the dataframe to produce the data
rm(current_info, percents, current_dis, current_file, district, i, out, thevalue)
```

#### Preterm Births
```{r}
percent_bf <- data.frame()

#This entire for loop will read all of the files based on the location on where the extract text is based on the coordinates and will produce the data in that same spot of each pdf page
for(i in seq_along(all_files)){
     
     current_file <- all_files[i]

     out <- extract_text(paste("Health_Profiles/",current_file, sep = ""), pages = 11, area = list(c(385, 28, 468, 445)))

     percents <- out %>% regmatches(., gregexpr("[0-9]{1,2}.[0-9]{1}\\%", .))

     current_info <- tibble(location = current_file, current_stats = percents)

     percent_bf <- percent_bf %>% bind_rows(current_info)

}

#Note: Some numbers in loops may be repeated because more numbers showed up repeated and required
#a second loop to be removed in certain places which will be explained below 
thedat <- percent_bf$current_stats

#This loop is for keeping a percentage at one district and removing it from all the other districts which is the greenpoint and williamsburg district
for (district in 1:59) {
        current_dis <- (thedat[[district]]) 
        if (("5.4%" %in% current_dis) & (district != 1)) {
                percent_bf$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "5.4%")
        }
}
#This is to remove the percentage from all the pdf files as it is not important which is the state NYC
thedat <- percent_bf$current_stats
for (district in 1:59) {
        current_dis <- thedat[[district]]
        percent_bf$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "8.7%")
}
#This is to remove the percentage from all the pdf files as it is not important which is the borough bronx
thedat <- percent_bf$current_stats
for (district in 19:30) {
        current_dis <- thedat[[district]]
        percent_bf$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "9.7%")

}
#This is to remove the percentage from all the pdf files as it is not important which is the borough Brooklyn
thedat <- percent_bf$current_stats
for (district in 1:18) {
        current_dis <- thedat[[district]]
        percent_bf$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "8.3%")

}
#Some percentages of brooklyn were not removed so i did another for loop to be able to remove them 
thedat <- percent_bf$current_stats
for (district in 16:18) {
    current_dis <- thedat[[district]]
   percent_bf$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "8.3%")

}
#This is to remove the percentage from all the pdf files as it is not important which is the borough Manhattan
thedat <- percent_bf$current_stats
for (district in 31:42) {
        current_dis <- thedat[[district]]
        percent_bf$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "8.3%")
}
#Some percentages of Manhattan were not removed so i did another for loop to be able to remove them 
thedat <- percent_bf$current_stats
for (district in 34:36) {
        current_dis <- thedat[[district]]
        percent_bf$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "8.3%")
}
#This is to remove the percentage from all the pdf files as it is not important which is the borough Queens
thedat <- percent_bf$current_stats
for (district in 43:56) {
        current_dis <- thedat[[district]]
        percent_bf$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "8.5%")
}
#This is to remove the percentage from all the pdf files as it is not important which is the borough Staten Island
thedat <- percent_bf$current_stats
for (district in 57:59) {
        current_dis <- thedat[[district]]
        percent_bf$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "8.6%")
}
#Below is to remove commas and to modify and organize the data
thedat <- percent_bf$current_stats
for (district in 1:59) {
percent_bf$current_stats[[district]] <- percent_bf$current_stats[[district]] %>%
 
   
str_remove_all(.,",") %>%
str_remove(.,"%") %>%
str_trim() %>%
as.numeric(.)
}
percent_bf$location <- substr(percent_bf$location,1,nchar(percent_bf$location)-4) # to remove .pdf from each district
colnames(percent_bf) <- c("District", "pretermbirth") # changing the names of each column
percent_bf$pretermbirth <- unlist(percent_bf$pretermbirth) # this is to flatten the second column


percent_bf #Initiating the dataframe to produce the data
rm(current_info, percents, thedat, current_dis,district, current_file, i, out)
```

#### Teen Births
```{r}
percent_tf <- data.frame()

#This entire for loop will read all of the files based on the location on where the extract text is based on the coordinates and will produce the data in that same spot of each pdf page
for(i in seq_along(all_files)){

     current_file <- all_files[i]

     out <- extract_text(paste("Health_Profiles/",current_file, sep = ""), pages = 11, area = list(c(550, 309, 596.5, 649)))

     percents <- out %>% regmatches(., gregexpr("[1-9]{1}[0-9]{0,1}\\.[0-9]{1}", .))

     current_info <- tibble(location = current_file,
                            current_stats = percents)

     percent_tf <- percent_tf %>% bind_rows(current_info)

}


percent_tf$location <- substr(percent_tf$location,1,nchar(percent_tf$location)-4)# to remove .pdf from each district
colnames(percent_tf) <- c("District", "teen_births")# changing the names of each column
percent_tf$teen_births<- unlist(percent_tf$teen_births)# this is to flatten the second column


percent_tf #Initiating the dataframe to produce the data

rm(current_info, percents, current_file, i, out)
```

#### Childhood Obesity
```{r}
co = {}

normal_area = list(c(140.4855, 310.5401, 196.7822, 395.8932))
hi_lo_area = list(c(140, 308, 245, 405))

for (i in 1:59){
  t_fname = paste("Health_Profiles/", all_files[i], sep="")
  # Determine search area
  if (all_files[i] == "mn1.pdf"){
    out <- extract_text(t_fname, pages = 12, area = hi_lo_area)} else{
      out <- extract_text(t_fname, pages = 12, area = normal_area)
    }
  
  # Clean string
  m <- sub("\\%.*", "", out)
  m <- gsub("[^0-9]", "", out)
  
  # Add value to dictionary
  temp <- as.numeric(m)
  temp <- temp / 100
  m = toString(temp)
  d = data.frame(District = str_extract(all_files[i], "(bx|qn|mn|si|bk)[0-9]{1,4}") ,Childhood_Obesity = m)
  co = rbind(co, d)
}

co
rm(normal_area, hi_lo_area, d, i, m, out, t_fname, temp)
```



#### Children Asthma Emergency Department Visits
```{r}
asthma = data.frame()

#Define search areas
normal_area = list(c(486.0637, 379.5929, 629.7451, 421.6460))
mn4_area = list(c(361.0286, 309.9740, 525.9506, 359.6494))
mn1_area = list(c(376.9247, 304.0130, 498.1325, 373.5584))
mn5_area = list(c(420.6390, 306.0000, 488.1974, 351.7013))
mn2_area = list(c(420.6390, 311.9610, 486.2104, 347.7273))
qn11_area = list(c(375.0857, 317.3143, 475.8857, 350.2286))

for (i in 1:59){
  t_fname = paste("Health_Profiles/", all_files[i], sep="")
  
  out <- extract_text(t_fname, pages = 12, area = normal_area)
  
  # Handle edge cases
  if (all_files[i] == "mn4.pdf"){
     out <- extract_text(t_fname, pages = 12, area = mn4_area)
  }else if (all_files[i] == "mn1.pdf"){
    out <- extract_text(t_fname, pages = 12, area = mn1_area)
  }else if (all_files[i] == "mn5.pdf"| all_files[i] =="mn6.pdf"){
    out <- extract_text(t_fname, pages = 12, area = mn5_area)
  }else if (all_files[i] == "mn2.pdf"){
    out <- extract_text(t_fname, pages = 12, area = mn2_area)
  }else if (all_files[i] == "qn11.pdf"){
    out <- extract_text(t_fname, pages = 12, area = qn11_area)
  }
  
  m <- gsub("\r?\n|\r|\n2", "", out) %>% 
    gsub("[^0-9]", "", .) %>% 
    gsub("10000", "", .)
  
  d = data.frame(District = str_extract(all_files[i], "(bx|qn|mn|si|bk)[0-9]{1,4}") ,Asthma = m)
  asthma = rbind(asthma, d)
}
asthma
rm(normal_area, mn1_area, mn2_area, mn4_area, mn5_area, qn11_area,  d, i, m, out, t_fname)
```
Combine Maternal and Child Health Statistics
```{r}
Maternal_Child <- left_join(percent_lnpc, percent_bf, by = "District") %>% left_join(., percent_tf, by = "District") %>% left_join(., co, by = "District") %>% left_join(., asthma, by = "District")
rm(percent_lnpc, percent_bf, percent_tf, co, asthma)
```


## Healthy Living

```{r}
Healthy_Living = matrix(NA, ncol = 4, nrow = 59)
areas = c(518, 249, 686, 290)

for(i in 1:59){
  pdfTxt = extract_text(paste("Health_Profiles/",pdf_path[i],sep = ""),pages = 13, area = list(areas))
  vals = unlist(str_match_all(pdfTxt,"[0-9]{1,2}%"))
  Healthy_Living[i,] = vals 
}

new_hl = gsub("%", "", Healthy_Living)
Healthy_Living = apply(new_hl, 2, as.numeric)/100
rm(new_hl, areas, i,pdfTxt,vals)

Healthy_Living = data.frame(cbind(Districts, Healthy_Living))
colnames(Healthy_Living) <- c("Districts",    
                              "Any_physical_activity_in_the_past_30_days",
                      "At_least_one_serving_of_fruits_or_vegetables_per_day",
                              "One_or_more_12-ounce_sugary_drinks_per_day",
                              "Current_Smokers")
```


## Healthcare

```{r}

ValuesWithCommas <- function(file, page, area){
  Val <- extract_text(file, pages= page, area= list(area)) %>%
    str_extract_all("[0-9]") %>% paste(unlist(.), collapse = "")
  return(Val)
}

Healthcare <- data.frame()
for(i in 1:59){
  #Identifies the documents
 doc <- paste("Health_Profiles/",all_files[i], sep="")
 df <- data.frame(
    Districts[i],
    NoInsurance = PercentExtract(doc, 14, c(251, 75, 290, 240)),
    WithoutCare = PercentExtract(doc, 14, c(270, 75, 430, 240)),
    AvoidableHosp = ValuesWithCommas(doc, 14, c(410, 309, 435, 520)),
    Falls = ValuesWithCommas(doc, 14, c(577, 308, 600, 520)),
    HPVVacc = PercentExtract(doc, 15, c(321, 35, 445, 75)),
    FluVacc = PercentExtract(doc, 15, c(321, 306, 445, 355)))
 Healthcare <- rbind(df, Healthcare)
}
rm(df, doc, i)
```

## Health Outcomes

#### Obesity, diabetes and hypertension
```{r}
Health_Outcomes = matrix(NA, ncol = 3, nrow = 59)
HOareas =  c(240, 174, 396, 241)

for(i in 1:59){
  pdfText = extract_text(paste("Health_Profiles/",all_files[i],sep = ""),pages = 16, area = list(HOareas))
  values = unlist(str_match_all(pdfText,"[0-9]{1,2}%"))
  Health_Outcomes[i,] = values
}

new_ho = gsub("%", "", Health_Outcomes)
Health_Outcomes = apply(new_ho, 2, as.numeric)/100
rm(new_ho, HOareas, i, pdfText, values)

Health_Outcomes = data.frame(cbind(Districts, Health_Outcomes))
colnames(Health_Outcomes) = c("Districts", "Obesity_Rates", "Diabetes_Rates", "Hypertension_Rates")
```


#### New HIV Diagnosis and New hepatitis C reports
```{r}

FromGraph <- function(file, page, area){
  Graph <- extract_text(file, pages= page, area= list(area)) %>% str_remove_all("\\\n") %>% 
    str_extract(., "[0-9]{1,3}\\.[0-9]{1}") %>% as.numeric(as.character(.))
  return(Graph)
}
HIVHep <- data.frame()
for(i in 1:59){
  doc <- paste("Health_Profiles/", all_files[i], sep="")
  df <- data.frame(
    Districts = Districts[i],
    NewHiv = FromGraph(doc, 16, c(490, 64, 660, 510)),
    NewHep = FromGraph(doc, 17, c(178, 61, 320, 510)))
    HIVHep <- rbind(HIVHep, df)
}
rm(df, doc, i)
```

#### Binge Drinking
```{r}
percent_bdr <- data.frame()

#This entire for loop will read all of the files based on the location on where the extract text is based on the coordinates and will produce the data in that same spot of each pdf page
for(i in seq_along(all_files)){
     
     current_file <- all_files[i]

out <- extract_text(paste("Health_Profiles/",current_file,sep = ""), pages = 17, area = list(c(406, 40, 482, 578)))

percents <- out %>% regmatches(., gregexpr("[0-9]{1,2}\\%", .))

current_info <- tibble(location = current_file, current_stats = percents)

percent_bdr <- percent_bdr %>% bind_rows(current_info)

}

the_val <- percent_bdr$current_stats
#I will be doing this to modify the data 
#Note: Some numbers in loops may be repeated because more numbers showed up repeated and required
#a second loop to be removed in certain places which will be explained below 

#This loop is for keeping a percentage at one current stats and removing it from all the other current stats which is bensonhurst
for (district in 1:59) {

     current_dis <- (the_val[[district]]) # to String function binds entire column in one string
     if (("9%" %in% current_dis) & (district != 3)) {
          percent_bdr$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "9%")
     }
}
#This is to remove the percentage from all the pdf files as it is not important which is the state NYC
the_val <- percent_bdr$current_stats
for (district in 1:59) {
     current_dis <- the_val[[district]]
     percent_bdr$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "17%")
}
#This is to remove the percentage from all the pdf files as it is not important which is the borough bronx
the_val <- percent_bdr$current_stats
for (district in 19:30) {
     current_dis <- the_val[[district]]
     percent_bdr$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "14%")
}
#This is to remove the percentage from all the pdf files as it is not important which is the borough Brooklyn
the_val <- percent_bdr$current_stats
for (district in 1:18) {
     current_dis <- the_val[[district]]
     percent_bdr$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "15%")
}
#This is to remove the percentage from all the pdf files that still remained from the other loop before this one 
the_val <- percent_bdr$current_stats
for (district in 3:6) {
        current_dis <- the_val[[district]]
        percent_bdr$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "15%")
}
#This is another loop to remove nyc that still had remained on the current stats
the_val <- percent_bdr$current_stats
for (district in 6:11) {
        current_dis <- the_val[[district]]
        percent_bdr$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "17%")
}
#This is another loop to remove nyc that still had remained on the current stats
the_val <- percent_bdr$current_stats
for (district in 17:19) {
        current_dis <- the_val[[district]]
        percent_bdr$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "17%")
}
#This is to remove the percentage from all the pdf files as it is not important which is the borough Manhattan
the_val <- percent_bdr$current_stats
for (district in 31:42) {
        current_dis <- the_val[[district]]
        percent_bdr$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "25%")
}
#This is another loop to remove nyc that still had remained on the current stats
the_val <- percent_bdr$current_stats
for (district in 42:55) {
        current_dis <- the_val[[district]]
        percent_bdr$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "17%")
}
#This is to remove the percentage from all the pdf files as it is not important which is the borough Queens
the_val <- percent_bdr$current_stats
for (district in 43:56) {
        current_dis <- the_val[[district]]
        percent_bdr$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "15%")
}
#This is to remove the percentage from all the pdf files as it is not important which is the borough Staten Island
the_val <- percent_bdr$current_stats
for (district in 57:59) {
        current_dis <- the_val[[district]]
        percent_bdr$current_stats[[district]] <- str_remove(string = toString(current_dis), pattern = "18%")
}
the_val <- percent_bdr$current_stats
#Below is to remove commas and to modify and organize the data
for (district in 1:59) {
       percent_bdr$current_stats[[district]] <- percent_bdr$current_stats[[district]] %>%
                str_remove_all(.,",") %>%
                str_remove(.,"%") %>%
               str_trim() %>%
                as.numeric(.)
}


percent_bdr$location <- substr(percent_bdr$location,1,nchar(percent_bdr$location)-4) # to remove .pdf from each district
colnames(percent_bdr) <- c("Districts", "binge_drinking") #changing the names of each of the columns
percent_bdr$binge_drinking <- unlist(percent_bdr$binge_drinking) #this is to flatten the second column
percent_bdr #Initiating the dataframe to produce the data
rm(current_info, percents, the_val, current_dis, current_file, district, i, out)
```

#### Psychiatric hospitalizations

```{r}
percent_ph <- data.frame()


#This entire for loop will read all of the files based on the location on where the extract text is based on the coordinates and will produce the data in that same spot of each pdf page
for(i in seq_along(all_files)){
    

     current_file <- all_files[i]

     out <- extract_text(paste("Health_Profiles/",current_file, sep= ""), pages = 17, area = list(c(555, 302, 584, 575)))

     percents <- out %>% regmatches(., gregexpr("[0-9]{0,1},{0,1}[0-9]{3,4}", .))

     current_info <- tibble(location = current_file,
                            current_stats = percents)

     percent_ph <- percent_ph %>% bind_rows(current_info)

}
the_val <- percent_ph$current_stats


percent_ph$location <- substr(percent_ph$location,1,nchar(percent_ph$location)-4)#This is to remove the .pdf from each district
colnames(percent_ph) <- c("Districts", "Psychiatric_Hospitilizations")#This is to change the names of each column
percent_ph$Psychiatric_Hospitilizations<- unlist(percent_ph$Psychiatric_Hospitilizations)#This is to flatten the second column

percent_ph #Initiating the dataframe to produce the data
rm(current_info, percents, the_val, current_file, i, out)
```

#### Infant mortality
```{r}
infant = data.frame()

normal_area = list(c(139.2497, 308.7358, 167.9751, 583.6788))
for (i in 1:59){
  t_fname = paste("Health_Profiles/", all_files[i], sep="")
  out <- extract_text(t_fname, pages = 18, area = normal_area)
  m <- str_extract(out, "\\d+\\.*\\d*")

  d = data.frame(Districts = str_extract(all_files[i], "(bx|qn|mn|si|bk)[0-9]{1,4}") ,infant_mortality = m) %>% 
    mutate(infant_mortality = as.numeric(infant_mortality))
  infant = rbind(infant, d)
}

infant
rm(d, normal_area,i, m, out, t_fname)
```

#### Premature death
```{r}
pd = data.frame()
#locate_areas(t_fname, page = 18)
# Define Search Areas
first_area = list(c(478.14466, 32.67961, 500.42621, 337.19417))
second_area = list(c(439.3931, 284.1517, 495.8345, 362.4414))
third_area = list(c(500.42621, 37.13592, 515.28058, 362.44660))
bk13 = list(c(434.7429, 278.2286, 471.7714, 364.6286))
bk18 = list(c(439.3931, 269.5862, 497.6552, 360.6207))
# Define District Sets
first_districts <- c( 'mn8', 'qn8', 'bx7', 'qn5', 'mn4', 'mn5', 'mn6', 'mn1', 'mn2', 'mn3')
second_districts <- c('qn7','qn10', 'qn12')

for (i in 1:59){
  t_fname = paste("Health_Profiles/", all_files[i], sep="")
  
  if (str_extract(all_files[i], "(bx|qn|mn|si|bk)[0-9]{1,4}") %in% first_districts){
    out <- extract_text(t_fname, pages = 18, area = first_area)
    m <- str_extract(out, "[0-9]+\\.[0-9]{1}")
  }else if (all_files[i] =='bk13.pdf'){
    out <- extract_text(t_fname, pages = 18, area = bk13)
    m <- str_extract(out, "[0-9]+\\.[0-9]{1}")
  }else if (all_files[i] =='bk18.pdf'){
    out <- extract_text(t_fname, pages = 18, area = bk18)
    m <- str_extract(out, "[0-9]+\\.[0-9]{1}")
  }else if (str_extract(all_files[i], "(bx|qn|mn|si|bk)[0-9]{1,4}") %in% second_districts){
    out <- extract_text(t_fname, pages = 18, area = second_area)
    m <- str_extract(out, "[0-9]+\\.[0-9]{1}")
  }else{
    out <- extract_text(t_fname, pages = 18, area = third_area)
    m <- str_extract(out, "[0-9]+\\.{1}[0-9]{1}")
  }
  
  d = data.frame(Districts = str_extract(all_files[i], "(bx|qn|mn|si|bk)[0-9]{1,4}") ,premature_deaths = m)
  pd = rbind(pd, d)
}

pd
rm(first_area, second_area, third_area, bk13, bk18, first_districts, second_districts, d, i, m, out, t_fname)
```

Combine Health Outcomes Statistics
```{r}
HealthOutcomes <- left_join(Health_Outcomes, HIVHep, by = "Districts") %>% 
  left_join(.,percent_bdr, by = "Districts") %>% left_join(., percent_ph, by = "Districts") %>% left_join(., infant, by = "Districts") %>% left_join(., pd, by = "Districts")
rm(Health_Outcomes, HIVHep, percent_bdr, percent_ph, infant, pd)
```



#Binder
```{r}
library(xlsx)
write.xlsx(data.frame(whoWeAre), file="NYC_CHP_DATA.xlsx", sheetName="WhoWeAre")
write.xlsx(Education, file="NYC_CHP_DATA.xlsx", sheetName="Education", append=TRUE)
write.xlsx(EconomicStress, file="NYC_CHP_DATA.xlsx", sheetName="EconomicStress", append=TRUE)
write.xlsx(Violence, file="NYC_CHP_DATA.xlsx", sheetName="Violence", append=TRUE)
write.xlsx(HousingNeighbourhoodConditions, file="NYC_CHP_DATA.xlsx", sheetName="Housing", append=TRUE)
write.xlsx(Maternal_Child, file="NYC_CHP_DATA.xlsx", sheetName="Maternal_Child", append=TRUE)
write.xlsx(Healthy_Living, file="NYC_CHP_DATA.xlsx", sheetName="HealthyLiving", append=TRUE)
write.xlsx(Healthcare, file="NYC_CHP_DATA.xlsx", sheetName="Healthcare", append=TRUE)
write.xlsx(HealthOutcomes, file="NYC_CHP_DATA.xlsx", sheetName="HealthOutcomes", append=TRUE)
```




